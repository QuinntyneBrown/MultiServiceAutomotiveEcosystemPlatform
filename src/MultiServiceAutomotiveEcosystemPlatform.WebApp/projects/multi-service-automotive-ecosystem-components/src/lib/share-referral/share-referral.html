<div
  class="share-referral-overlay"
  (click)="close()"
  (keydown)="onKeydown($event)"
  role="presentation"
>
  <div
    class="share-referral-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="share-modal-title"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <header class="modal-header">
      <h2 id="share-modal-title" class="modal-title">Share Your Referral</h2>
      <button
        type="button"
        class="close-button"
        (click)="close()"
        aria-label="Close modal"
      >
        &times;
      </button>
    </header>

    <!-- Tab Bar -->
    <nav class="tab-bar" role="tablist" aria-label="Share methods">
      <button
        role="tab"
        class="tab-button"
        [class.active]="activeTab() === 'copy-link'"
        [attr.aria-selected]="activeTab() === 'copy-link'"
        (click)="switchTab('copy-link')"
      >
        Copy Link
      </button>
      <button
        role="tab"
        class="tab-button"
        [class.active]="activeTab() === 'email'"
        [attr.aria-selected]="activeTab() === 'email'"
        (click)="switchTab('email')"
      >
        Email
      </button>
      <button
        role="tab"
        class="tab-button"
        [class.active]="activeTab() === 'sms'"
        [attr.aria-selected]="activeTab() === 'sms'"
        (click)="switchTab('sms')"
      >
        SMS
      </button>
      <button
        role="tab"
        class="tab-button"
        [class.active]="activeTab() === 'social'"
        [attr.aria-selected]="activeTab() === 'social'"
        (click)="switchTab('social' as any)"
      >
        Social
      </button>
      <button
        role="tab"
        class="tab-button"
        [class.active]="activeTab() === 'qr-code'"
        [attr.aria-selected]="activeTab() === 'qr-code'"
        (click)="switchTab('qr-code')"
      >
        QR Code
      </button>
    </nav>

    <!-- Tab Content -->
    <div class="modal-content">
      <!-- Copy Link Tab -->
      @if (activeTab() === 'copy-link') {
        <div
          role="tabpanel"
          aria-labelledby="copy-link-tab"
          class="tab-panel"
        >
          <p class="tab-description">
            Copy your unique referral link and share it anywhere.
          </p>

          <div class="url-container">
            <input
              #urlInput
              type="text"
              class="url-input"
              [value]="referralUrl"
              readonly
              (click)="selectUrlInput()"
              aria-label="Referral URL"
            />
            <button
              type="button"
              class="copy-button"
              [class.copied]="isCopied()"
              (click)="copyLink()"
            >
              @if (isCopied()) {
                <span class="copy-icon">&#10003;</span> Copied!
              } @else {
                <span class="copy-icon">&#128203;</span> Copy
              }
            </button>
          </div>

          @if (isCopied()) {
            <div class="success-toast" role="status" aria-live="polite">
              Link copied to clipboard!
            </div>
          }
        </div>
      }

      <!-- Email Tab -->
      @if (activeTab() === 'email') {
        <div role="tabpanel" class="tab-panel">
          <p class="tab-description">
            Send your referral link via email to one or more recipients.
          </p>

          <form [formGroup]="emailForm" (ngSubmit)="sendEmail()" class="share-form">
            <div class="form-group">
              <label for="email-recipients" class="form-label">
                Recipients <span class="required">*</span>
              </label>
              <input
                type="text"
                id="email-recipients"
                formControlName="recipients"
                class="form-input"
                [class.error]="getEmailError('recipients')"
                placeholder="email@example.com, another@example.com"
              />
              @if (getEmailError('recipients')) {
                <span class="form-error">{{ getEmailError('recipients') }}</span>
              }
              <span class="form-hint">Separate multiple emails with commas</span>
            </div>

            <div class="form-group">
              <label for="email-subject" class="form-label">Subject</label>
              <input
                type="text"
                id="email-subject"
                formControlName="subject"
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label for="email-message" class="form-label">
                Message
                <span class="character-count">{{ emailCharCount }}/2000</span>
              </label>
              <textarea
                id="email-message"
                formControlName="message"
                class="form-input form-textarea"
                rows="4"
              ></textarea>
              @if (getEmailError('message')) {
                <span class="form-error">{{ getEmailError('message') }}</span>
              }
            </div>

            <div class="preview-box">
              <span class="preview-label">Preview</span>
              <p class="preview-content">
                {{ emailForm.get('message')?.value }}
                <br /><br />
                <a [href]="referralUrl" class="preview-link">{{ referralUrl }}</a>
              </p>
            </div>

            <button
              type="submit"
              class="btn btn-primary btn-full"
              [disabled]="isLoading()"
            >
              @if (isLoading()) {
                <span class="spinner"></span> Sending...
              } @else {
                Send Email
              }
            </button>
          </form>
        </div>
      }

      <!-- SMS Tab -->
      @if (activeTab() === 'sms') {
        <div role="tabpanel" class="tab-panel">
          <p class="tab-description">
            Send your referral link via SMS.
          </p>

          <form [formGroup]="smsForm" (ngSubmit)="sendSms()" class="share-form">
            <div class="form-group">
              <label for="sms-phone" class="form-label">
                Phone Number <span class="required">*</span>
              </label>
              <input
                type="tel"
                id="sms-phone"
                formControlName="phoneNumber"
                class="form-input"
                [class.error]="getSmsError('phoneNumber')"
                placeholder="(555) 123-4567"
                (input)="formatPhoneNumber($event)"
              />
              @if (getSmsError('phoneNumber')) {
                <span class="form-error">{{ getSmsError('phoneNumber') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="sms-message" class="form-label">
                Message
                <span class="character-count" [class.warning]="smsCharCount > 140" [class.error]="smsCharCount > 160">
                  {{ smsCharCount }}/160
                </span>
              </label>
              <textarea
                id="sms-message"
                formControlName="message"
                class="form-input form-textarea"
                rows="3"
              ></textarea>
              @if (getSmsError('message')) {
                <span class="form-error">{{ getSmsError('message') }}</span>
              }
              @if (smsCharCount > 160) {
                <span class="form-warning">Message will be sent as multiple SMS segments</span>
              }
            </div>

            <button
              type="submit"
              class="btn btn-primary btn-full"
              [disabled]="isLoading()"
            >
              @if (isLoading()) {
                <span class="spinner"></span> Sending...
              } @else {
                Send SMS
              }
            </button>
          </form>
        </div>
      }

      <!-- Social Tab -->
      @if (activeTab() === 'social') {
        <div role="tabpanel" class="tab-panel">
          <p class="tab-description">
            Share your referral link on social media.
          </p>

          <div class="social-buttons">
            <button
              type="button"
              class="social-button facebook"
              (click)="shareSocial('facebook')"
              aria-label="Share on Facebook"
            >
              <span class="social-icon">f</span>
              Facebook
            </button>
            <button
              type="button"
              class="social-button twitter"
              (click)="shareSocial('twitter')"
              aria-label="Share on Twitter/X"
            >
              <span class="social-icon">X</span>
              Twitter/X
            </button>
            <button
              type="button"
              class="social-button whatsapp"
              (click)="shareSocial('whatsapp')"
              aria-label="Share on WhatsApp"
            >
              <span class="social-icon">W</span>
              WhatsApp
            </button>
            <button
              type="button"
              class="social-button linkedin"
              (click)="shareSocial('linkedin')"
              aria-label="Share on LinkedIn"
            >
              <span class="social-icon">in</span>
              LinkedIn
            </button>
          </div>
        </div>
      }

      <!-- QR Code Tab -->
      @if (activeTab() === 'qr-code') {
        <div role="tabpanel" class="tab-panel">
          <p class="tab-description">
            Scan this QR code to open your referral link.
          </p>

          <div class="qr-container">
            @if (qrCodeDataUrl()) {
              <img
                [src]="qrCodeDataUrl()"
                alt="QR Code for referral link"
                class="qr-code-image"
              />
            } @else {
              <div class="qr-loading">
                <span class="spinner"></span>
                Generating QR code...
              </div>
            }
          </div>

          <div class="download-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              (click)="downloadQR('png')"
            >
              Download PNG
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              (click)="downloadQR('svg')"
            >
              Download SVG
            </button>
          </div>
        </div>
      }
    </div>
  </div>
</div>
