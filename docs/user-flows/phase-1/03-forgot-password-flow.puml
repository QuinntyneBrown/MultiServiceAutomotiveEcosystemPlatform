@startuml forgot-password-flow
title Forgot Password Flow - Phase 1

skinparam activityBackgroundColor #E3F2FD
skinparam activityBorderColor #1976D2
skinparam activityDiamondBackgroundColor #FFF3E0
skinparam activityDiamondBorderColor #F57C00

start

:Customer clicks "Forgot Password" link;

:Display forgot password form;

:Customer enters email address;

:Customer submits form;

:System validates email format;

if (Email format valid?) then (yes)
  :System checks if account exists;

  note right
    Always show success message
    to prevent email enumeration
  end note

  if (Account exists?) then (yes)
    :System generates password reset token;
    :System stores token with expiration (24h);
    :System sends password reset email;
  else (no)
    :Log attempt for security monitoring;
  endif

  :Display "Check your email" message;

  :Customer receives email;
  :Customer clicks reset link;

  :System validates reset token;

  if (Token valid and not expired?) then (yes)
    :Display password reset form;

    :Customer enters new password;
    :Customer confirms new password;

    :System validates password;

    if (Password meets requirements?) then (yes)
      if (Passwords match?) then (yes)
        :System updates password;
        :System invalidates reset token;
        :System invalidates all existing sessions;
        :System sends password changed notification;

        :Display "Password Changed" success;
        :Redirect to Login page;
        stop
      else (no)
        :Display "Passwords do not match" error;
        stop
      endif
    else (no)
      :Display password requirements error;
      note right
        Requirements:
        * Minimum 8 characters
        * At least 1 uppercase
        * At least 1 number
        * At least 1 special char
      end note
      stop
    endif
  else (no)
    :Display "Link expired or invalid" error;
    :Show "Request new link" option;
    stop
  endif
else (no)
  :Display "Invalid email format" error;
  stop
endif

@enduml
